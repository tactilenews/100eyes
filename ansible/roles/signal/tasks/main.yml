---
- pause:
    prompt: "{{ lookup('template', 'enter_captcha.j2') | trim }}"
  register: captcha_prompt_result

- set_fact:
    captcha: "{{ captcha_prompt_result.user_input }}"

- name: Register phone number
  uri:
    url: "{{ signal_rest_cli_endpoint }}/v1/register/{{ signal_phone_number }}"
    method: POST
    status_code: 201
    body_format: json
    body: "{{ lookup('template','register.json.j2') }}"

- pause:
    prompt: "{{ lookup('template', 'enter_verification_token.j2') | trim }}"
  register: verification_token_prompt_result

- set_fact:
    verification_token: "{{ verification_token_prompt_result.user_input }}"

- name: Verify phone number
  uri:
    url: "{{ signal_rest_cli_endpoint }}/v1/register/{{ signal_phone_number }}/verify/{{ verification_token }}"
    method: POST
    status_code: 201
    body_format: json
    body: { "ping": "string" }

- name: Setup cronjob to receive messages
  ansible.builtin.cron:
    name: "Receive signal messages"
    minute: "*" # job gets run every minute
    job: "cd {{ ansible_facts.env.HOME }} && docker exec ansible_app_1 bin/rails signal:receive_messages"

