---
- pause:
    prompt: "{{ lookup('template', 'enter_captcha.j2') | trim }}"
  register: captcha_prompt_result

- set_fact:
    captcha: "{{ captcha_prompt_result.user_input }}"

- name: Register phone number
  uri:
    url: "{{ signal_rest_cli_endpoint }}/v1/register/{{ signal_server_phone_number }}"
    method: POST
    status_code: 201
    body_format: json
    body:
      captcha: "{{ captcha }}"

- pause:
    prompt: "{{ lookup('template', 'enter_verification_token.j2') | trim }}"
  register: verification_token_prompt_result

- set_fact:
    verification_token: "{{ verification_token_prompt_result.user_input }}"

- name: Verify phone number
  uri:
    url: "{{ signal_rest_cli_endpoint }}/v1/register/{{ signal_server_phone_number }}/verify/{{ verification_token }}"
    method: POST
    status_code: 201
    body_format: json
    body:
      ping: "string"

- name: Query id of app container
  command:
    cmd: docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps -q app
    chdir: /home/ansible
  register: get_container_id

- name: Save container id of app
  set_fact:
    app_container_id: "{{ get_container_id.stdout }}"

- name: Setup cronjob to receive messages
  ansible.builtin.cron:
    name: "Receive signal messages"
    minute: "*" # job gets run every minute
    job: "cd {{ ansible_facts.env.HOME }} && docker exec -it app_container_id bin/rails signal:receive_messages"

