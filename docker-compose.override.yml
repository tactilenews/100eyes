version: '3.7'

x-dev-defaults: &x-dev-defaults
  build:
    context: .
  environment:
    HUNDRED_EYES_PROJECT_NAME: "${HUNDRED_EYES_PROJECT_NAME}"
    RAILS_ENV: "${RAILS_ENV:-development}"
    NODE_ENV: "${NODE_ENV:-development}"
    MAILSERVER_HOST: mailserver
    MAILSERVER_PORT: 1025
    POSTGRES_HOST: db
    WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
  stdin_open: true
  tty: true
  volumes:
    - .:/app

services:
  telegram:
    <<: *x-dev-defaults
    command: rake telegram:bot:poller

  app:
    <<: *x-dev-defaults
    depends_on: [ db, mailserver, assets ]
    ports:
      - 3000:3000
      - 3035:3035

  assets:
    command: yarn run build
    <<: *x-dev-defaults

  job-worker:
    <<: *x-dev-defaults

  db:
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
    ports: [ '5432:5432' ]

  mailserver:
    image: maildev/maildev:2.0.2
    ports: [ '1080:1080', '1025:1025' ]
